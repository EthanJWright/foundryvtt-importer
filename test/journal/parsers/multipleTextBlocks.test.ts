import { parseMultipleTextBlocks } from '../../../src/module/journal/parsers/multipleTextBlocks';

describe('parseTextBlock', () => {
  it('should parse a dnd beyond map layout', () => {
    const input =
      'K1. Storeroom\n\nThe outer door is locked from the inside, and the room has neither heat nor light sources. Crates stacked around the room are packed with meat, and bear the seal of the Fellowship of Salters, Packers, and Joiners.\nK2. Dining Room\n\nThis room contains the following features:\n\n    Three Zhents in black armor sit around a stone dining table, playing Three-Dragon Ante (a card game). The table is set with silver.\n    Eight moth-eaten banners hang from the walls. Each bears an arcane sigil that represents a different one of the eight schools of magic.\n\nZhents. The card players are Sidra Romeir (LE female Calishite human veteran) and two subordinates (LE male Tethyrian human thugs). Since the force field around Kolat Towers keeps out riffraff, Sidra assumes the characters are guests of Manshoon arriving for a clandestine meeting. If the characters give her no reason to believe otherwise, she and her thugs escort them wherever they ask to go. If it becomes clear that the characters don’t belong in the towers, Sidra and her thugs attack. Combat in this area draws the attention of Manafret Cherryport in area K3, who investigates.\n\nSidra wears a teleporter ring (see “Teleporter Rings”).\n\nTreasure. Silverware on the table is worth 100 gp.\nK3. Kitchen\n\nMouthwatering scents fill this room, which contains the following features:\n\n    If he hasn’t already been drawn elsewhere, a portly halfling stands atop a stool and cooks at an iron stove.\n    A green, ghostly hand floats above a trellis table, holding a knife and cutting carrots and celery.\n    A staircase curves up one wall, leading to area K7.\n\nZhent Cook. The halfling, Manafret Cherryport, is one of Manshoon’s lieutenants. He loves to cook, and uses his mage hand cantrip to cut vegetables. He assumes the characters are intruders unless convinced otherwise. Any ability check to do so is made with disadvantage, since Manafret knows that Manshoon would have informed him if guests were expected. If the mage suspects the characters are intruders, he surreptitiously pours a vial of assassin’s blood (see “Poisons” in chapter 8 of the Dungeon Master’s Guide) into the stew before asking them to taste it and give him an honest critique. He then cries out to the guards in area K2 and attacks. Combat in this area draws the attention of the Zhents in areas K2 and K7, who investigate.\n\nManafret is a lightfoot halfling mage, with these changes:\n\n    Manafret is neutral evil and has 31 (9d6) hit points.\n    He has these racial traits: He is Small, and his walking speed is 25 feet. He can move through the space of a Medium or larger creature. He has advantage on saving throws against being frightened. He speaks Common and Halfling.\n\nManafret wears a teleporter ring (see “Teleporter Rings”).\n\nTreasure. A cupboard holds a dozen jars of herbs and spices. Among them is a flask labeled “Assassin’s Blood,” which contains six doses of the poison.\nK4. Musty Library\n\nThis musty room is situated at the bottom of the main tower, and it has no door on level 1. It contains the following features:\n\n    A suit of dented plate armor stands in the center of the room.\n    Tomes are packed into built-in stone bookshelves, with a tall alcove above each shelf holding a gargoyle. (Two of these sculptures are living gargoyles.)\n    An in-progress game of Dragonchess sits on a marble table in a reading nook.\n    A stone staircase spirals up to area K6.\n\nGargoyles. The two real gargoyles are indistinguishable from the inanimate gargoyle statues in the high alcoves. When intruders start poking around the room, the gargoyles swoop down and attack.\n\nTomes. Any character who spends an hour searching the bookshelves finds a fat tome titled Flumph Mating Rituals, with an embossed image of two flumphs on the cover, their tendrils entwined. The cover is a false one, wrapping around a tome bound in dragon hide — a disguised spellbook that contains the following wizard spells: arcane lock, burning hands, comprehend languages, counterspell, darkvision, dimension door, find familiar, levitate, sending, and unseen servant. (You can replace any of these spells with a spell of the same level.)\n\nTreasure. The Dragonchess set is made of hand-carved ivory and is worth 500 gp.\nK5. Garbage-Filled Room\n\nThis room is on level 1 of the outermost tower but isn’t accessible from that floor. It reeks of garbage and has the following features:\n\n    Ankle-deep refuse fills the chamber.\n    Black scorch marks stretch from floor to ceiling along the walls and the stairs, which lead up to area K10.\n\nManshoon’s servants throw their garbage here. The Kolat brothers created some magic items in this room, and an experiment gone awry caused the scorch marks.\nK6. Main Tower Landing and Ledge\n\nLevel 2 of the main tower has the following features:\n\n    A stone landing with no railings has a door leading to area K7 and a stone spiral staircase descending to area K4. An invisible staircase with no railings (see “Kolat Towers Features”) hugs the wall as it climbs from the landing to area K11.\n    Across from the landing, a wide stone ledge protrudes from the northeast wall beneath a window. A pair of identical wooden chests sits atop the ledge. (One chest is real. The other is a mimic.)\n\nLedge. There’s no easy way to access the ledge, which is 8 feet away from the landing and at the same height. Characters can try to jump onto the ledge, or they can hook a rope onto the railing on the level above (area K11) and swing across the gap. They can also use magic to cross. Anyone who falls off the landing or the ledge lands in area K4, 20 feet below.\n\nMimic. A character who touches the mimic becomes adhered to it. The mimic attacks if disturbed or when a character inspects the real chest next to it.\n\nTreasure. The genuine chest is unlocked and contains thirteen items, each of which can be used as an arcane focus: two crystals (worth 10 gp each), an orb (worth 20 gp), four rods (worth 10 gp each), and six wands (worth 10 gp each).\nK7. Reading Room\n\nThis room contains the following features:\n\n    A burly half-orc clad in black leather armor sits in an overstuffed chair in the northernmost corner of the room, reading a book.\n    Large framed pictures of cities and landscapes hang on the walls, and a worn, blood-spattered rug covers the floor. Other furnishings include a pair of rocking chairs, a couch, and an ottoman.\n    Mouthwatering scents rise from a staircase that curves down to the kitchen (area K3).\n\nZhent. Yorn the Terror is reading a copy of Volo’s Guide to Monsters, autographed on the title page by the author with an added note that reads, in Common: “For Yorn. I hope you find the orc chapter illuminating!”\n\nYorn is a half-orc thug, with these changes:\n\n    Yorn is neutral evil.\n    He has these racial traits: When reduced to 0 hit points, he drops to 1 hit point instead (but can’t do this again until he finishes a long rest). He has darkvision out to a range of 60 feet. He speaks Common and Orc.\n\nYorn values his own well-being above all else. He is initially indifferent toward intruders. If Yorn believes the characters aren’t a threat, he’s happy to chat with them about the inhabitants and the layout of Kolat Towers. He has never visited Manshoon’s extraplanar sanctum, but he does know that the teleportation circle in area K22 is the way to get there.\n\nCombat in this area draws the attention of Manafret Cherryport in area K3, who investigates.\n\nTreasure. Yorn carries 36 cp, 20 sp, 12 gp, 8 taols, and a gem-studded ivory toothpick (worth 25 gp) in a pouch.\nK8. Apprentice Bedroom\n\nThis narrow room contains the following features:\n\n    Three single beds are bunched less than an arm’s length apart beneath a staircase that leads up to area K12.\n    At the foot of each bed is a wooden chest.\n\nThe Kolat brothers once took on apprentices, who slept here. Manshoon now allows his own apprentices — Ered Payno, Havi Termock, and Savara Firethorn — to do the same. All three can be found in area K15.\n\nTreasure. Inside each chest is a set of common clothes, a spare spell component pouch, candles, ink, pens, paper, and 3d6 gp. Each chest also holds a spellbook that contains all the spells its owner has prepared. In addition, Ered’s spellbook contains burning hands, knock, and lightning bolt; Havi’s spellbook contains charm person, detect thoughts, and major image; and Savara’s spellbook contains comprehend languages, phantasmal force, and phantom steed.\nK9. Bridge and Walkway\n\nA wooden bridge connects the two towers 20 feet above the ground, and a walkway attached to the bridge encircles the outside of the outer tower. The bridge and the tower walkway lack railings. Their planks and stones groan and crack underfoot but are safe to walk on.\nK10. Wizard Statue\n\nThis level of the outer tower consists of a landing and a narrow ledge with the following features:\n\n    The landing is 10 feet square and is met by two staircases. One descends 20 feet to area K5, and one ascends 20 feet to area K20.\n    The narrow ledge built into the southeast wall has a life-size statue of a bearded human wizard standing atop it. The wizard looks angry and is leveling a stone wand at the door to area K9.\n\nStatue. The statue depicts Duhlark Kolat, and a detect magic spell or similar magic reveals an aura of transmutation magic around it. The first time a character steps onto the landing, the statue levitates 1 foot above the ledge and intones the following warning in Common:\n\n    “I am Duhlark Kolat, the great wizard and master of this tower! How dare you invade my home! Leave at once or be destroyed by magic beyond your comprehension!”\n\nThe threat is empty, but the statue continues to levitate for 1 minute before sinking back down to the ledge. The magic resets after 1 hour. While it is levitating, the statue can be easily pushed or pulled around.\n\nCasting dispel magic on the statue while it’s floating causes it to fall, topple off the ledge, and shatter in area K5 below. Anyone in that area when the statue falls must succeed on a DC 10 Dexterity saving throw or take 22 (4d10) bludgeoning damage.\nK11. Laboratory\n\nThis room consists of a ledge connected to the levels above and below by invisible staircases (see “Kolat Towers Features”). One staircase descends 20 feet to area K6, and the other climbs 20 feet to area K15. The area contains the following features:\n\n    Shattered glass covers the floor, and a large wooden trellis table has been knocked on its side.\n    A large empty cabinet dominates the back wall.\n\nThis laboratory has been picked clean by Manshoon and contains nothing of value.\nK12. Staff Display\n\nThis room contains the following features:\n\n    A half-dozen staffs of various styles are hung proudly on the walls at the top of the landing.\n    A staircase descends to area K8.\n\nStaffs. Each staff is different in construction and style: a twisted birch branch, a sturdy oak dowel, a glittering haft of stone, a steel pole carved with blue runes, a dimpled copper staff topped with a copper crescent moon, and a blown-glass cane capped with a black marble orb.\n\nAll six staffs animate and attack interlopers who enter the area without being escorted by Manshoon or one of his lieutenants. The staffs have the same statistics as flying swords, except they deal bludgeoning damage on a hit. If a fight breaks out in this area, the creatures in area K14 come to investigate.\nK13. Holding Cell\n\nThe door to this room has a narrow, barred window set into it. The door is locked and trapped (see below). As the characters approach the door, read:\n\n    A raspy voice calls out from beyond the door. “If you be good, let us rid these towers of evil’s stench. If you be evil, open the door so we may battle, and my eternal boredom can end.” Beyond the door’s barred window, a gargoyle lurks in a stone cell, challenging you in a low growl. “Come on, then!”\n\nTrapped Door. A glyph of warding spell has been cast on the door, set to trigger when it is opened by anyone other than Manshoon. The glyph, which resembles an ornate letter M, can be found with a successful DC 18 Intelligence (Investigation) check. The glyph targets the creature that opens the door with a blindness/deafness spell (save DC 18).\n\nLady Gondafrey. Duhlark Kolat long ago trapped a magical experiment in this cell: a gargoyle that has been imbued with the personality of a human knight of Tyr (god of justice) named Lady Gondafrey. This gargoyle has an Intelligence score of 10 and an alignment of lawful good. It speaks Common, and its face looks more humanoid than gargoyle. Manshoon is amused by the creature, so he keeps it alive but locked in the cell.\n\nIf the characters free Lady Gondafrey, she offers to fight alongside them; however, she quickly turns against any character who exhibits cruel or unlawful behavior. She can offer helpful information about Kolat Towers, and she is familiar with both the layout of the towers and the current occupants of the place. She knows that Manshoon resides in an extraplanar sanctum accessible through a teleportation circle that his lieutenants can activate using special rings. The gargoyle doesn’t know where the teleportation circle is located, nor does she know why Duhlark transferred her consciousness into her present form.\n\nThe gargoyle retains fragmented memories of the life of Lady Gondafrey, a native Waterdavian who served in the City Watch. After identifying Duhlark Kolat as a suspect in several local disappearances, she darkened his doorstep in 1379 DR, the Year of the Lost Keep. Annoyed by this invasion of his privacy and not in his right mind, Duhlark captured Lady Gondafrey, used a spell to meld her form with that of a gargoyle, and imprisoned her.\n\nIf the gargoyle travels with the party, roll a d10 each day at dawn. On a roll of 1, Lady Gondafrey’s alignment becomes chaotic evil for 24 hours as the gargoyle’s innate demeanor exerts itself. In this state, the creature tries to orchestrate the characters’ deaths, going so far as to attack lone characters.\nK14. Servants’ Quarters\n\nThis room contains the following features:\n\n    Furnishings include four beds, a small table with four chairs, and tattered window curtains.\n    Four Zhent thugs relax here — one trying to rest, two others playing cards, and the fourth sitting on the edge of a bed, re-stringing a heavy crossbow.\n\nThe thugs work for Manshoon and leap up to attack anyone they don’t recognize as one of their own. A successful DC 17 Charisma (Deception) check convinces these Zhents that the characters are their allies.\n\nTreasure. Resting in small piles and neat stacks on the table are 74 cp, 52 sp, 19 gp, and 4 taols.\nK15. Summoning Chamber\n\nThis room is connected to the levels above and below by invisible staircases (see “Kolat Towers Features”), one descending 20 feet to area K11 and the other climbing 20 feet to area K16. This area contains the following features:\n\n    A 10-foot-diameter circle of runes has been drawn on the floor in blood that is now dried. Smoke billows from four iron braziers placed around the circle.\n    Three apprentice wizards (see appendix B) stand outside the circle, chanting an incantation. A barlgura is slumped motionless within the circle.\n\nThe three wizards here are Manshoon’s apprentices — Ered Payno (LE male Damaran human), Havi Termock (CE female Chondathan human), and Savara Firethorn (NE female Tethyrian human). Each wears a teleporter ring (see “Teleporter Rings”). The magical incantation that the three are reciting has quelled the barlgura and rendered it unconscious. If any of them stop chanting, the demon awakes and becomes enraged, though it remains bound within the circle. Whenever it takes damage, the barlgura can attempt a DC 10 Charisma check. On a successful check, it breaks out of the circle and attacks any creature it can reach.\n\nFreeing the barlgura disrupts Manshoon’s operation, forcing the wizard to spend time and resources defeating the fiend and replacing slain underlings.\nK16. Construct Workshop\n\nThe invisible staircase from area K15 ends in front of a closed door. The door is unlocked and opens into the room, which contains the following:\n\n    Bits of clay, stone, bone, and metal litter the floor and cover a wooden table in the middle of the room.\n    The floor creaks and tilts slightly when stepped on, and it can be seen to be detached from the walls. Two oversized iron clamps on opposite sides of the room hold the floor in place. Each of these rusty mechanisms is attached to an iron lever.\n    A wooden staircase once climbed 20 feet to the next level, but it has partially collapsed.\n\nThe Kolat brothers once crafted constructs in this workshop. The magical clamped floor was built as a precaution in case one of the experiments went berserk.\n\nWhen a creature that doesn’t work for Manshoon’s Zhentarim enters this room without being escorted, the metal scraps on the floor fly together, forming a suit of animated armor that attacks. When the armor is reduced to 10 hit points or fewer, it tries to pull one of the levers on its next turn.\n\nFloor Clamps. Pulling a lever is an action that causes both clamps to release the floor, which is then magically driven upward into the ceiling. Creatures standing on the floor are knocked prone and must make a DC 20 Dexterity saving throw as they slam into the ceiling, taking 22 (4d10) bludgeoning damage on a failed save, or half as much damage on a successful one. The floor then settles a few feet below the ceiling, cutting off access to the stairs down to area K15 but leaving characters free to climb up the collapsed staircase to area K17. (The magical floor was designed to prevent a berserk golem from reaching the lower chambers of the towers, and potentially the city beyond, while the Kolat brothers dealt with it.) After 10 minutes, the floor descends to its normal level and the clamps lock it down again.\n\nPartially Collapsed Stairs. A creature can climb the stairs to area K17 with a successful DC 10 Dexterity (Acrobatics) check. If the check fails, the creature falls 10 feet.\nK17. Flesh Golem\n\nThis unlit hallway contains the following features:\n\n    Any character who inspects the hall for traps and succeeds on a DC 17 Wisdom (Perception) check notices 1-inch-diameter holes drilled into the walls at ankle height, set at regular intervals along the length of the passage.\n    A flesh golem stands in front of the door to area K18.\n    A one-way secret door is set into the innermost wall.\n\nGolem Trap. The flesh golem was created by Duhlark Kolat. Manshoon chose to leave it here and instructed his lieutenants not to disturb it. It moves to attack anyone other than Duhlark who approaches within 10 feet of it. A character disguised as Duhlark (using the statue in area K10 as a model) can fool the golem with a successful DC 10 Charisma (Deception) check.\n\nThe golem stands on a pressure plate. When it steps off the plate to attack someone out of its reach, the weight on the plate is lifted, causing poison gas to erupt from the holes in the walls. When the trap triggers, each creature in the hall must make a DC 12 Constitution saving throw, taking 10 (3d6) poison damage on a failed saving throw, or half as much damage on a successful one. The gas lingers for 1 minute unless dispersed with a gust of wind spell or similar magic. While the gas persists, a creature in the hall must repeat the saving throw at the start of each of its turns. The golem is immune to the poison gas.\n\nOne-Way Secret Door. A character who makes a successful DC 15 Wisdom (Perception) check notices the secret door that leads to area K19. This door opens normally only from inside area K19, and only a knock spell or similar magic can force it open from this side.\n\nNat, Jenks, and Squiddly make the best of Waterdeep’s harsh winter.\nK18. Arcane Rune\n\nThis unlit hall is choked with dust and cobwebs. It contains the following features:\n\n    An elaborate rune is inscribed on the back wall at the southernmost end of the hall. (The rune isn’t visible from the doorway to area K17.)\n    A secret door is set into the innermost wall.\n\nArcane Rune. A detect magic spell or similar magic reveals a powerful aura of conjuration magic around the rune. A successful DC 15 Intelligence (Arcana) check confirms that this rune sustains the force field around Kolat Towers, and that the rune can be destroyed. It has AC 10, 22 hit points, and immunity to poison and psychic damage. The rune can’t be dispelled normally, but each successful dispel magic cast on it (DC 19) deals 16 (3d10) force damage to it.\n\nThe first time damage is dealt to the rune, a red slaad magically springs forth from it and attacks all creatures in the hallway.\n\nWhen the rune is destroyed, the force field around Kolat Towers disappears.\n\nSecret Door. A character who makes a successful DC 15 Wisdom (Perception) check notices the secret door that leads to area K19.\nK19. Duhlark’s Bedroom\n\nThis room is accessible through either of the secret doors that lead to areas K17 and K18. It contains the following features:\n\n    A flameskull bobs in the middle of the room, which is choked with dust and cobwebs.\n    An oval canopy bed veiled in cobwebs sits across from two narrow bookshelves.\n    The room smells like a tomb.\n\nManshoon found Duhlark Kolat’s skeletal remains in the bed and transformed his skull into a flameskull. He left the rest of the bones alone, hidden behind cobwebs. The flameskull attacks anyone other than Manshoon who confronts it, shouting, “Get out of my house!” between casting spells and throwing off fire rays.\n\nBookshelves. Manshoon removed any tomes of value from the bedroom, leaving noticeable gaps on the shelves between mundane books on a variety of esoteric subjects.\n\nAmong the volumes on one shelf is a false book titled The Man from Damara — a wooden block painted to resemble a book, which is wired to a secret compartment in the base of the shelf. A character can detect the shelf and discern how to open it with a successful DC 15 Wisdom (Perception) check. Tugging on the book causes the compartment to pop open, revealing Duhlark’s wand of binding hidden inside.\nK20. Alcedor’s Private Library\n\nThis room has the following features:\n\n    A tall oak bookshelf contains a few scattered books (all mundane and worthless), but is mostly bare. Above the bookshelf hangs a beautifully crafted sign that reads “Alcedor” in Common.\n    A staircase descends 20 feet to area K10.\n\nK21. Duhlark’s Private Library\n\nThis room has the following features:\n\n    A tall oak bookshelf holds a few dozen books. Above the bookshelf hangs a beautifully crafted sign that reads “Duhlark” in Common.\n    A staircase ascends 20 feet to area K22.\n\nBookshelf. The bookshelf holds thirty books in total. If any of them are disturbed, they fly off the shelves and form a swarm that attacks all creatures in the room. The book collection has the statistics of a swarm of bats, with these changes:\n\n    The books lack the Echolocation and Keen Hearing traits.\n    Replace the swarm’s Bites attack option with a Slam attack option that deals the same amount of bludgeoning damage.\n\nIf there are no creatures to attack on its turn, the book collection returns to the bookshelf. The books are otherwise nonmagical and cover a wide array of subjects.\nK22. Teleportation Circle\n\nA staircase rising from area K21 leads to this highest chamber of the outer tower. It contains the following features:\n\n    A spectator floats in the middle of the room, and four flying snakes flutter above the rafters.\n    Runes inscribed on the floor form a large, faintly glowing circle.\n    Five wooden treasure chests with sturdy padlocks rest against the walls.\n\nGuardians. The spectator guards the treasure chests and attacks intruders who aren’t being escorted by Manshoon or one of his lieutenants. The flying snakes join the battle, fighting as allies of the spectator.\n\nTeleportation Circle. The teleportation circle functions as described under the spell of the same name in the Player’s Handbook. Additionally, a creature wearing a teleporter ring (see “Teleporter Rings”) can use this circle to access the teleportation circle in Manshoon’s sanctum (area E1). A teleporter ring that is brought within 5 feet of the circle begins to hum softly.\n\nTreasure Chests. The padlocks on the chests are illusory but feel real to the touch. A detect magic spell or similar magic reveals an aura of illusion magic around each one. Attempts to pick or break the locks fail, but a knock spell or similar magic causes a lock to open.\n\nChest 1 has the image of an anvil carved into its lid. It contains a set of smith’s tools (worth 20 gp).\n\nChest 2 has iron bands and contains a set of painter’s supplies (worth 10 gp), as well as three small pots of colored paint (blue, red, and yellow).\n\nChest 3 has tiny clawed feet and contains six blank spellbooks with leather covers (worth 50 gp each).\n\nChest 4 has a flat lid with a city scene painted on it. It contains a scholar’s pack (worth 40 gp) and a book of Dwarvish phrases. A character who doesn’t speak Dwarvish can use the book to communicate on a rudimentary level with friendly dwarves.\n\nChest 5 is inlaid with silver and topped with a silver statuette of a rearing hippogriff (worth 25 gp). Inside is a wooden rack that holds eight glass vials — six containing potions of healing and two containing individual doses of essence of ether (see “Poisons” in chapter 8 of the Dungeon Master’s Guide). The poison can be identified with a successful DC 13 Intelligence (Nature) check.';
    const parsed = parseMultipleTextBlocks(input);
    expect(parsed.entries.length).toBe(22);
  });
});
